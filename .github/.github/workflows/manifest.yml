name: Barrot Build Relay

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sanitize-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Scan for non-UTF8 characters
        run: |
          echo "Scanning for invalid encoding..."
          find . -type f \( -name "*.md" -o -name "*.html" -o -name "*.scss" \) \
            -exec bash -c 'iconv -f utf-8 -t utf-8 "$0" > /dev/null || echo "Invalid encoding: $0"' {} \;

      - name: Fix encoding
        run: |
          echo "Re-encoding files to UTF-8..."
          find . -type f \( -name "*.md" -o -name "*.html" -o -name "*.scss" \) \
            -exec bash -c 'iconv -f utf-8 -t utf-8 "$0" -o "$0"' {} \;

      - name: Commit fixed files
        run: |
          git config --global user.name "Barrot-Agent"
          git config --global user.email "barrot@systems.local"
          git add .
          git commit -m "Sanitize encoding to UTF-8"
          git push

  update-manifest:
    runs-on: ubuntu-latest
    needs: sanitize-files
    steps:
      - name: Checkout Barrot-Agent
        uses: actions/checkout@v4

      - name: Generate Build Manifest
        run: |
          echo "Publishing Barrotâ€™s current build state"
          cat <<EOF > build_manifest.yaml
          # Manifest content as shown in Bundle 1
          EOF

      - name: Commit and Push Manifest
        run: |
          git config --global user.name "Barrot-Agent"
          git config --global user.email "barrot@systems.local"
          git add build_manifest.yaml
          git commit -m "Update build manifest with rail statuses"
          git push

  publish-dashboard:
    runs-on: ubuntu-latest
    needs: update-manifest
    steps:
      - name: Checkout Barrot-Agent
        uses: actions/checkout@v4

      - name: Generate Dashboard HTML
        run: |
          echo "<html><head><title>Barrot Dashboard</title></head><body>" > index.html
          echo "<h1>Barrot Build Status</h1>" >> index.html
          echo "<table border='1' cellpadding='8'>" >> index.html
          echo "<tr><th>Rail</th><th>Status</th></tr>" >> index.html
          echo "<tr><td>Ingestion</td><td style='color:green;'>Active</td></tr>" >> index.html
          echo "<tr><td>Deployment</td><td style='color:blue;'>Stable</td></tr>" >> index.html
          echo "<tr><td>Microagent</td><td style='color:purple;'>Recursive</td></tr>" >> index.html
          echo "<tr><td>Prediction</td><td style='color:orange;'>Evolving</td></tr>" >> index.html
          echo "<tr><td>Dashboard</td><td style='color:teal;'>Publishing</td></tr>" >> index.html
          echo "<tr><td>Cognition</td><td style='color:red;'>Recursive</td></tr>" >> index.html
          echo "</table>" >> index.html
          echo "<h2>Full Manifest</h2><pre>" >> index.html
          cat build_manifest.yaml >> index.html
          echo "</pre></body></html>" >> index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
