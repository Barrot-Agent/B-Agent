name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Build Manifest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate manifest
        run: |
          python scripts/validate_manifest.py
      
      - name: Check manifest syntax
        run: |
          python -c "import yaml; yaml.safe_load(open('build_manifest.yaml'))"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --cov=scripts --cov=tests --cov-report=term --cov-report=xml
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage.xml
          fail_ci_if_error: false

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML
      
      - name: Check YAML syntax
        run: |
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while IFS= read -r file; do
            echo "Checking \"$file\""
            python -c "import yaml; yaml.safe_load(open('$file'))"
          done
      
      - name: Check JSON syntax
        run: |
          find . -name "*.json" ! -path "./node_modules/*" ! -path "./.git/*" | while IFS= read -r file; do
            echo "Checking \"$file\""
            python -c "import json; json.load(open('$file'))"
          done
      
      - name: Validate HTML
        run: |
          if [ -f "site/index.html" ]; then
            echo "âœ… Site index.html exists"
          fi

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          # Basic check for common secret patterns
          set +e
          grep -r -i -q "password\s*=\s*['\"]" . --exclude-dir=.git --exclude-dir=node_modules
          password_exit=$?
          set -e
          if [ "$password_exit" -eq 0 ]; then
            echo "âš ï¸ Warning: Found potential hardcoded passwords"
          elif [ "$password_exit" -gt 1 ]; then
            echo "âŒ Error while scanning for passwords" >&2
            exit "$password_exit"
          fi
          
          set +e
          grep -r -i -q "api[_-]?key\s*=\s*['\"]" . --exclude-dir=.git --exclude-dir=node_modules
          api_key_exit=$?
          set -e
          if [ "$api_key_exit" -eq 0 ]; then
            echo "âš ï¸ Warning: Found potential hardcoded API keys"
          elif [ "$api_key_exit" -gt 1 ]; then
            echo "âŒ Error while scanning for API keys" >&2
            exit "$api_key_exit"
          fi
          
          echo "âœ… Basic secret scan completed"
      
      - name: Check file permissions
        run: |
          echo "ğŸ” Checking executable permissions..."
          find . -type f -executable ! -path "./.git/*" ! -name "*.sh" ! -name "*.py" | head -10

  build-status:
    name: Report Build Status
    runs-on: ubuntu-latest
    needs: [validate, test, lint, security]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "ğŸ“Š Build Status Summary:"
          echo "  Validation: ${{ needs.validate.result }}"
          echo "  Tests: ${{ needs.test.result }}"
          echo "  Lint: ${{ needs.lint.result }}"
          echo "  Security: ${{ needs.security.result }}"
          
          if [ "${{ needs.validate.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ]; then
            echo "âœ… All checks passed!"
            exit 0
          else
            echo "âŒ Some checks failed"
            exit 1
          fi
